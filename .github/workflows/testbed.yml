name: testbed
on:
  push:

jobs:
  sandbox:
    runs-on: [ self-hosted, X64, Linux ]
    name: "sandbox"
    timeout-minutes: 30
    steps:
      - name: export runner UID
        run: echo "runner_uid=$UID" >> $GITHUB_ENV
      - name: Checkout Repo
        uses: actions/checkout@v3
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: adopt
          java-version: 17
          cache: gradle
      - name: Split tests
        id: split-tests
        uses: chaosaffe/split-tests@v1-alpha.1
        with:
          glob: 'acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/**/*Test.java'
          split-total: 1
          split-index: 0
      - name: write out test list
        run: echo "${{ steps.split-tests.outputs.test-suite }}" >> testList.txt
      - name: debug testList
        run: cat testList.txt
      - name: format gradle args
        #regex means: first truncate file paths to align with package name, then swap path delimiter with package delimiter,
        #then drop file extension, then insert --tests option between each.
        run: cat testList.txt | sed -e 's@acceptance-tests/tests/src/test/java/@@g' -e 's@/@.@g' -e 's/\.java//g' -e 's/\ /\ --tests\ /g' >> gradleArgs.txt
      - name: args are
        run: cat gradleArgs.txt
      - name: run acceptance tests
        run: ./gradlew acceptanceTest --tests `cat gradleArgs.txt` --scan
      - name: cleanup tempfiles
        run: rm testList.txt gradleArgs.txt